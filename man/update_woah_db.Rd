% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/db_update.R
\name{update_woah_db}
\alias{update_woah_db}
\title{Update WOAH Outbreak Data in a PostgreSQL/PostGIS Database (Refactored)}
\usage{
update_woah_db(
  start_date,
  end_date,
  disease_name = NULL,
  db_params,
  batch_interval = "1 month",
  table_prefix = "wahis_",
  language = "en",
  verbose = TRUE
)
}
\arguments{
\item{start_date}{Character string or Date object for the start of the overall date range (YYYY-MM-DD).}

\item{end_date}{Character string or Date object for the end of the overall date range (YYYY-MM-DD).}

\item{disease_name}{Optional: Character string specifying the exact disease name to filter by.
If NULL (default), fetches data for all diseases.}

\item{db_params}{A list containing database connection parameters:
\itemize{
  \item `dbname`: Database name
  \item `host`: Database host
  \item `port`: Database port
  \item `user`: Database user
  \item `password`: Database password
}}

\item{batch_interval}{Character string specifying the interval for batch processing
(e.g., "1 month", "2 weeks", "10 days"). Default is "1 month". Set to `NULL`
to process the entire range at once (not recommended for large ranges).}

\item{table_prefix}{Character string prefix for all created/updated database tables. Default is "wahis_".}

\item{language}{Language code for API requests (default: "en").}

\item{verbose}{Logical: Print progress messages? (Default: TRUE for this function).}
}
\value{
Invisibly returns TRUE if completed (potentially with warnings), or FALSE if a critical error occurred during fetching or writing.
}
\description{
Fetches all outbreak data (locations and full details) from the WOAH API for a
specified date range first, then connects to the database to upsert the
combined data into corresponding tables in a PostgreSQL database with the
PostGIS extension. Tables are created if they don't exist.
}
\details{
This refactored function performs the following steps:
\enumerate{
  \item Splits the date range into smaller intervals if necessary (using `batch_interval`).
  \item For each date interval:
    \itemize{
      \item Fetches location data using `rwahis::get_woah_outbreak_locations`.
      \item Fetches full outbreak details using `rwahis::get_woah_outbreaks_full_info`.
      \item Stores the fetched data in memory.
    }
  \item After fetching all data:
    \itemize{
      \item Combines the data from all batches.
      \item Connects to the specified PostgreSQL database.
      \item Defines target table names (prefixed with `table_prefix`).
      \item Checks if each target table exists. If not, it creates the table.
      \item Performs database write operations within a transaction:
        \itemize{
          \item For each combined data table (locations, outbreak, speciesQuantities, etc.):
            \itemize{
              \item Identifies new records based on primary keys (existing records are skipped).
              \item Appends only the new records to the corresponding database table.
              \item Location data is converted to `sf` objects before writing.
            }
        }
      \item Disconnects from the database.
    }
}

**Required Database Setup:** (Same as before)
\itemize{
  \item PostgreSQL server.
  \item PostGIS extension enabled (`CREATE EXTENSION postgis;`).
  \item User specified in `db_params` needs connection and table creation/write permissions.
}

**Table Schema Notes:** (Same as before)
\itemize{
 \item `locations`: PK: `outbreak_id`.
 \item `outbreak`: PK: `outbreak_id`.
 \item `quantity_unit`: PK: `outbreak_id`.
 \item `admin_divisions`: PK: `outbreak_id`, `area_id`.
 \item `species_quantities`: PK: `outbreak_id`, `species_id`.
 \item `control_measures`: PK: `outbreak_id`, `measure_id`.
 \item `diagnostic_methods`: PK: `outbreak_id`, `nature_id`.
}
}
\examples{
\dontrun{
# Database connection parameters (replace with your actual details)
db_connection_params <- list(
  dbname = "animal_health_db",
  host = "localhost",
  port = 5432,
  user = "db_user",
  password = "your_password"
)

# Update HPAI data for March 2025 in monthly batches
update_woah_db(
  start_date = "2025-03-01",
  end_date = "2025-03-31",
  disease_name = "Influenza A virus (Inf. with high pathogenicity) (OIE-listed)",
  db_params = db_connection_params,
  batch_interval = "1 month"
)

# Update all FMD data for Q1 2025 in 2-week batches
update_woah_db(
  start_date = "2025-01-01",
  end_date = "2025-03-31",
  disease_name = "Foot and mouth disease virus (Inf. with) ",
  db_params = db_connection_params,
  batch_interval = "2 weeks",
  table_prefix = "fmd_"
)
}
}
